function zf(e,a){return 1+.02*Math.pow(1-e/a,3)}function makeGuiObjects(e){var a={closed:!1,remembered:{}};return _.each(e,function(e){a.remembered[e.name]={0:_.omit(e,"rules","actions")};var r={"default":{0:{}}};for(var n in e.rules)_.has(e.rules,n)&&(r["default"]["0"][n]=e.rules[n]);var t={"default":{0:{}}};for(var o in e.actions)_.has(e.actions,o)&&(t["default"]["0"][o]=e.actions[o]);a.folders={Rules:{closed:!1,remembered:r,preset:"default"},Actions:{closed:!1,remembered:t,preset:"default"}}}),a}var FractalViewer={model:null,ctx:null,gui:null,editor:null,mouseX:0,mouseY:0,offsetX:0,offsetY:0,dragging:!1,zoom:1,guiState:{}};FractalViewer.zoomIn=function(){function e(){a=window.requestAnimationFrame(e),r=zf(Date.now()-o,t),n.zoom*=r,n.ctx.scale(r,r),n.model.render()}var a,r,n=this,t=500,o=Date.now();e(),window.setTimeout(function(){window.cancelAnimationFrame(a)},t)},FractalViewer.zoomOut=function(){function e(){a=window.requestAnimationFrame(e),r=zf(Date.now()-o,t),n.zoom/=r,n.ctx.scale(1/r,1/r),n.model.render()}var a,r,n=this,t=500,o=Date.now();e(),window.setTimeout(function(){window.cancelAnimationFrame(a)},t)},FractalViewer.initialize=function(){function e(e){_.each(e.__controllers,e.remove,e),e.__controllers=[];for(var a in r.rules)_.has(r.rules,a)&&(_.contains(r.variables,a)?e.add(r.rules,a):delete r.rules[a])}function a(e){_.each(e.__controllers,e.remove,e),e.__controllers=[];var a=_.union(r.variables.split(""),r.constants.split("")).join("");for(var n in r.actions)_.has(r.actions,n)&&(_.contains(a,n)?e.add(r.actions,n):delete r.actions[n])}null!==FractalViewer.editor&&FractalViewer.editor.destroy();var r=LSModels[0];r.compile=function(){var e=FractalViewer.model=new LS({parameters:r});e.setContext(FractalViewer.ctx).render(),null!==FractalViewer.gui&&FractalViewer.gui.destroy(),FractalViewer.gui=new dat.GUI,FractalViewer.gui.add(e,"iterate"),FractalViewer.gui.add(e,"regress");var a=FractalViewer.gui.addFolder("Style");a.add(e.options,"fill").onChange(function(){e.render()}),a.addColor(e.options,"foreground").onChange(function(){e.render()}),a.addColor(e.options,"background").onChange(function(){e.render()}),a.addColor(e.options,"lineColor").onChange(function(){e.render()}),a.add(e.options,"lineWidth").min(0).max(10).step(.5).onChange(function(){e.render()})};var n=FractalViewer.editor=new dat.GUI({load:FractalViewer.guiState,preset:"Dragon Curve"});n.remember(r),n.add(r,"compile"),n.add(r,"name"),n.add(r,"variables").onChange(function(n){var i=n.replace(/\s/g,"").split("");_.each(i,function(e){_.has(r.rules,e)||(r.rules[e]="")}),e(t);var c=_.union(r.constants.replace(/\s/g,"").split(""),i);_.each(c,function(e){_.has(r.actions,e)||(r.actions[e]="none")}),a(o)}),n.add(r,"constants").onChange(function(e){var n=_.union(r.variables.replace(/\s/g,"").split(""),e.replace(/\s/g,"").split(""));_.each(n,function(e){_.has(r.actions,e)||(r.actions[e]="none")}),a(o)}),n.add(r,"axiom");var t=n.addFolder("Rules");e(t);var o=n.addFolder("Actions");a(o)},window.addEventListener("load",function(){var e=document.createElement("canvas");e.width=window.innerWidth,e.height=window.innerHeight,document.body.appendChild(e),FractalViewer.ctx=e.getContext("2d"),FractalViewer.guiState=makeGuiObjects(LSModels),FractalViewer.initialize(),e.addEventListener("mousedown",function(e){FractalViewer.dragging=!0,FractalViewer.mouseX=e.clientX,FractalViewer.mouseY=e.clientY},!1),document.addEventListener("mousemove",function(e){FractalViewer.dragging&&(FractalViewer.offsetX+=(e.clientX-FractalViewer.mouseX)/FractalViewer.zoom,FractalViewer.offsetY+=(e.clientY-FractalViewer.mouseY)/FractalViewer.zoom,FractalViewer.mouseX=e.clientX,FractalViewer.mouseY=e.clientY,FractalViewer.model.render())},!1),document.addEventListener("mouseup",function(){FractalViewer.dragging=!1},!1),document.addEventListener("keyup",function(e){if(e.target===document.body)switch(e.which){case 37:FractalViewer.model.regress();break;case 39:FractalViewer.model.iterate();break;case 38:FractalViewer.zoomIn();break;case 40:FractalViewer.zoomOut()}},!1)},!1);